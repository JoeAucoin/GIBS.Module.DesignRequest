@using System
@using Oqtane.Models
@using System.Linq
@using Oqtane.Modules.Controls
@using Oqtane.Security
@using Oqtane.Services
@using GIBS.Module.DesignRequest.Models
@using System.Globalization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Text.Json


@namespace GIBS.Module.DesignRequest
@inherits ModuleBase
@inject Services.IDesignRequestService DesignRequestService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<List> Localizer
@inject ISettingService SettingService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService
@inject IProfileService ProfileService
@inject IJSRuntime JS



@if (_designRequests == null)
{
    <p><em>@Localizer["Loading..."]</em></p>
}
else
{
    <div class="row mb-3">
        <div class="col-md-8 offset-md-1">
            <label for="searchaddress">Project Address:</label>
            <input id="searchaddress" class="form-control" @bind="SearchAddressInput" placeholder="Search Project Address" />
        </div>
        <div class="col-md-2 align-self-end">
            <button class="btn btn-secondary" @onclick="SearchAddress">Search</button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-2 offset-md-1">
            <label for="statusFilter">Project Status:</label>
            <select id="statusFilter" class="form-select" @bind="SelectedProjectStatus">
                <option value="">All</option>
                @if (_projectStatus != null)
                {
                    @foreach (var status in _projectStatus)
                    {
                        <option value="@status">@status</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-2">
            <label for="projectManagerFilter">Project Manager:</label>
            <select id="projectManagerFilter" class="form-select" @bind="SelectedProjectManagerId">
                <option value="0">All</option>
                @if (_projectManagerUsers != null)
                {
                    @foreach (var user in _projectManagerUsers)
                    {
                        <option value="@user.UserId">@user.DisplayName</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-2">
            <label for="assignedToFilter">Assigned To:</label>
            <select id="assignedToFilter" class="form-select" @bind="SelectedAssignedToId">
                <option value="0">All</option>
                @if (_designerUsers != null)
                {
                    @foreach (var user in _designerUsers)
                    {
                        <option value="@user.UserId">@user.DisplayName</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-2">
            <label for="statusFilter">Design Status:</label>
            <select id="statusFilter" class="form-select" @bind="SelectedStatus">
                <option value="">All</option>
                @if (_statusOptions != null)
                {
                    @foreach (var status in _statusOptions)
                    {
                        <option value="@status">@status</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3 align-self-end">
            <button class="btn btn-secondary" @onclick="ClearFilters">Clear Filters</button> 
            @if (FiltersActive)
            {
                <span class="badge bg-warning text-dark ms-2">Filters Applied</span>
            }
        </div>

    </div>

    <Pager Items="@_designRequests" PageSize="10" Class="table table-striped">
        <Header>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("DesignRequestId"))">
            @Localizer["ID"]
            @GetSortIcon("DesignRequestId")
        </th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("ProjectStatus"))">
            @Localizer["ProjectStatus"]
            @GetSortIcon("ProjectStatus")
        </th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("ContactName"))">
            @Localizer["ContactName"]
            @GetSortIcon("ContactName")
        </th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("Address"))">
            @Localizer["Project Address"]
            @GetSortIcon("Address")
        </th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("Status"))">
            @Localizer["Status"]
            @GetSortIcon("Status")
        </th>
        <th>@Localizer["ProjectManager"]</th>
        <th>@Localizer["AssignedTo"]</th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("CreatedOn"))">
            @Localizer["Created On"]
            @GetSortIcon("CreatedOn")
        </th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("ModifiedOn"))">
            @Localizer["Updated On"]
            @GetSortIcon("ModifiedOn")
        </th>
        <th style="cursor: pointer;" @onclick="@(() => SortTable("ModifiedBy"))">
            @Localizer["Updated By"]
            @GetSortIcon("ModifiedBy")
        </th>
        <th>@Localizer["NewNoteAddedRecently"]</th>
        <th>@Localizer["FileUploadedRecently"]</th>
        <th style="width: 1px;">&nbsp;</th>
        <th style="width: 1px;">&nbsp;</th>
        </Header>
        <Row>
            <td>@context.DesignRequestId</td>
            <td>@context.ProjectStatus</td>
            <td>@context.ContactName</td>
            <td>@context.Address</td>
            <td>@context.Status</td>
            <td>@GetUserName(context.ProjectManagerUserId ?? 0)</td>
            <td>@GetUserName(context.AssignedToUserId)</td>
            <td>@context.CreatedOn.ToLocalTime().ToShortDateString()</td>
            <td>@context.ModifiedOn.ToLocalTime().ToShortDateString()<br />@context.ModifiedOn.ToLocalTime().ToShortTimeString()</td>
            <td>@context.ModifiedBy</td>
            <td>
                @if (context.NoteAddedRecently)
                {
                    <span class="oi oi-comment-square" title="Internal Note added recently" style="color: dodgerblue;font-size: 24px;"></span>
                }
            </td>
            <td>

                @if (context.FileUploadedRecently)
                {
                    <span class="oi oi-file" title="File uploaded recently" style="color: green;font-size: 24px;"></span>
                }
            </td>
            <td>
                <ActionLink Action="Edit" Parameters="@($"id={context.DesignRequestId}")" Class="btn btn-primary btn-sm"
                            Security="SecurityAccessLevel.View" ResourceKey="EditButton" Text="@Localizer["EditButton"]" IconName="pencil" IconOnly="true" />
            </td>
            <td>
                <ActionDialog Header="@Localizer["Header.Delete"]" Message="@(Localizer["Message.Delete", context.ProjectName])"
                              Action="Delete" Security="SecurityAccessLevel.Admin" Class="btn btn-danger btn-sm" IconName="delete" IconOnly="true"
                              OnClick="@(async () => await Delete(context.DesignRequestId))" ResourceKey="Delete"
                              Id="@context.DesignRequestId.ToString()" />
            </td>
        </Row>
    </Pager>

    <div class="text-center mt-3 mb-3">
        <ActionLink Action="BackOffice" Security="SecurityAccessLevel.Edit" Style="margin-right:10px;" Class="btn btn-secondary" IconName="menu" Text="Return to BackOffice" ResourceKey="BackOffice" />

    </div>
}


@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;
    public override bool UseAdminContainer => false;

    private List<Models.DesignRequest> _allDesignRequests;
    private List<Models.DesignRequest> _designRequests;
    private List<User> _users;
    private List<User> _designerUsers;
    private List<User> _projectManagerUsers;
    private List<string> _statusOptions = new();
    private List<string> _projectStatus = new();

    private bool IsDesignerRole { get; set; }
    private string _designerRole;
    private string _projectManagerRole;
    private int _designerUserId = 0;

    private int _selectedProjectManagerId = 0;
    private int _selectedAssignedToId = 0;
    private string _selectedStatus = "";
    private string _selectedProjectStatus = "";

    private string _sortColumn = "DesignRequestId";
    private bool _sortAscending = false;

    // address search input (bound to UI)
    private string SearchAddressInput { get; set; } = string.Empty;
    // active search term used when filtering
    private string _searchAddress = string.Empty;

    // Filter Persistence
    private string _storageKey => $"GIBS_DesignRequest_List_{ModuleState.ModuleId}_FilterState";
    private bool FiltersActive =>
        _selectedProjectManagerId != 0 ||
        _selectedAssignedToId != 0 ||
        !string.IsNullOrEmpty(_selectedStatus) ||
        !string.IsNullOrEmpty(_selectedProjectStatus) ||
        !string.IsNullOrWhiteSpace(_searchAddress) ||
        !string.IsNullOrWhiteSpace(SearchAddressInput);

    private class FilterState
    {
        public string SearchAddressInput { get; set; }
        public int SelectedProjectManagerId { get; set; }
        public int SelectedAssignedToId { get; set; }
        public string SelectedStatus { get; set; }
        public string SelectedProjectStatus { get; set; }
        public string SortColumn { get; set; }
        public bool SortAscending { get; set; }
    }

    private int SelectedProjectManagerId
    {
        get => _selectedProjectManagerId;
        set
        {
            _selectedProjectManagerId = value;
            ApplyFilters();
        }
    }

    private int SelectedAssignedToId
    {
        get => _selectedAssignedToId;
        set
        {
            _selectedAssignedToId = value;
            ApplyFilters();
        }
    }

    private string SelectedStatus
    {
        get => _selectedStatus;
        set
        {
            _selectedStatus = value;
            ApplyFilters();
        }
    }
    private string SelectedProjectStatus
    {
        get => _selectedProjectStatus;
        set
        {
            _selectedProjectStatus = value;
            ApplyFilters();
        }
    }

    private void SortTable(string columnName)
    {
        if (_sortColumn == columnName)
        {
            _sortAscending = !_sortAscending;
        }
        else
        {
            _sortColumn = columnName;
            // set default sort to descending on first click
            _sortAscending = false;
        }
        ApplyFilters();
    }

    private RenderFragment GetSortIcon(string columnName)
    {
        if (_sortColumn != columnName) return null;
        if (_sortAscending)
        {
            return @<span class="oi oi-caret-top"></span>;
        }
        else
        {
            return @<span class="oi oi-caret-bottom"></span>;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CheckAuthenticationAsync();

            var settings = await SettingService.GetModuleSettingsAsync(ModuleState.ModuleId);
            _designerRole = SettingService.GetSetting(settings, "DesignerRole", "DesignRequest");
            _projectManagerRole = SettingService.GetSetting(settings, "ProjectManagerRole", "Administrators");

            var statusList = SettingService.GetSetting(settings, "StatusList", "");
            if (!string.IsNullOrEmpty(statusList))
            {
                _statusOptions = statusList.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).ToList();
            }
            else
            {
                _statusOptions = new List<string> { "New Project", "Assigned", "Ready For Review", "Completed" };
            }

            var projectStatusList = SettingService.GetSetting(settings, "ProjectStatusList", "");
            if (!string.IsNullOrEmpty(projectStatusList))
            {
                _projectStatus = projectStatusList.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).ToList();
            }
            else
            {
                _projectStatus = new List<string> { "Active", "On Hold", "InActive", "Sold" };
            }

            await CheckUserRoleAsync(_designerRole);

            _allDesignRequests = await DesignRequestService.GetDesignRequestsAsync(ModuleState.ModuleId);
            _users = await DesignRequestService.GetUsersAsync();
            _designerUsers = await DesignRequestService.GetUsersByRoleAsync(PageState.Site.SiteId, _designerRole);
            _projectManagerUsers = await DesignRequestService.GetUsersByRoleAsync(PageState.Site.SiteId, _projectManagerRole);

            await LoadFiltersAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Loading Design Requests {Error}", ex.Message);
            AddModuleMessage(Localizer["Error Loading Design Requests"], MessageType.Error);
        }
    }

    private async Task CheckAuthenticationAsync()
    {
        // @inject AuthenticationStateProvider AuthenticationStateProvider
        // @inject NavigationManager NavigationManager

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity == null || !user.Identity.IsAuthenticated)
        {
            var returnUrl = Uri.EscapeDataString(NavigationManager.Uri);
            // Redirect to the Oqtane login page, appending the current URL as a return parameter
            NavigationManager.NavigateTo(NavigateUrl());
        }
    }

    private void ApplyFilters()
    {
        IEnumerable<Models.DesignRequest> query = _allDesignRequests;

        if (_designerUserId > 0)
        {
            query = query.Where(r => r.AssignedToUserId == _designerUserId);
        }

        if (_selectedProjectManagerId != 0)
        {
            query = query.Where(r => r.ProjectManagerUserId == _selectedProjectManagerId);
        }

        if (_selectedAssignedToId != 0)
        {
            query = query.Where(r => r.AssignedToUserId == _selectedAssignedToId);
        }

        if (!string.IsNullOrEmpty(_selectedStatus))
        {
            query = query.Where(r => r.Status == _selectedStatus);
        }

        if (!string.IsNullOrEmpty(_selectedProjectStatus))
        {
            query = query.Where(r => r.ProjectStatus == _selectedProjectStatus);
        }

        // address search (partial, case-insensitive)
        if (!string.IsNullOrWhiteSpace(_searchAddress))
        {
            var term = _searchAddress.Trim();
            query = query.Where(r => !string.IsNullOrEmpty(r.Address) && r.Address.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0);
        }

        // Sorting logic
        query = _sortColumn switch
        {
            //ProjectStatus
            "ProjectStatus" => _sortAscending ? query.OrderBy(r => r.ProjectStatus) : query.OrderByDescending(r => r.ProjectStatus),
            "DesignRequestId" => _sortAscending ? query.OrderBy(r => r.DesignRequestId) : query.OrderByDescending(r => r.DesignRequestId),
            "ContactName" => _sortAscending ? query.OrderBy(r => r.ContactName) : query.OrderByDescending(r => r.ContactName),
            "Address" => _sortAscending ? query.OrderBy(r => r.Address) : query.OrderByDescending(r => r.Address),
            "Status" => _sortAscending ? query.OrderBy(r => r.Status) : query.OrderByDescending(r => r.Status),
            "CreatedOn" => _sortAscending ? query.OrderBy(r => r.CreatedOn) : query.OrderByDescending(r => r.CreatedOn),
            "ModifiedOn" => _sortAscending ? query.OrderBy(r => r.ModifiedOn) : query.OrderByDescending(r => r.ModifiedOn),
            "ModifiedBy" => _sortAscending ? query.OrderBy(r => r.ModifiedBy) : query.OrderByDescending(r => r.ModifiedBy),
            _ => query.OrderByDescending(r => r.DesignRequestId),
        };

        _designRequests = query.ToList();

        // Save state to local storage (fire and forget)
        _ = SaveFiltersAsync();

        StateHasChanged();
    }

    private void SearchAddress()
    {
        _searchAddress = SearchAddressInput?.Trim() ?? string.Empty;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        // Use the properties to ensure filtering is re-applied
        _selectedProjectManagerId = 0; // Set backing fields to avoid multiple ApplyFilters calls
        _selectedAssignedToId = 0;
        _selectedStatus = "";
        _selectedProjectStatus = "";
        SearchAddressInput = string.Empty;
        _searchAddress = string.Empty;
        ApplyFilters();
    }

    private async Task SaveFiltersAsync()
    {
        try
        {
            var filterState = new FilterState
            {
                SearchAddressInput = SearchAddressInput,
                SelectedProjectManagerId = _selectedProjectManagerId,
                SelectedAssignedToId = _selectedAssignedToId,
                SelectedStatus = _selectedStatus,
                SelectedProjectStatus = _selectedProjectStatus,
                SortColumn = _sortColumn,
                SortAscending = _sortAscending
            };

            var json = JsonSerializer.Serialize(filterState);
            await JS.InvokeVoidAsync("localStorage.setItem", _storageKey, json);
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Saving Filter State");
        }
    }

    private async Task LoadFiltersAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", _storageKey);
            if (!string.IsNullOrEmpty(json))
            {
                var filterState = JsonSerializer.Deserialize<FilterState>(json);
                if (filterState != null)
                {
                    SearchAddressInput = filterState.SearchAddressInput;
                    _searchAddress = filterState.SearchAddressInput; // Apply search
                    _selectedProjectManagerId = filterState.SelectedProjectManagerId;
                    _selectedAssignedToId = filterState.SelectedAssignedToId;
                    _selectedStatus = filterState.SelectedStatus;
                    _selectedProjectStatus = filterState.SelectedProjectStatus;
                    _sortColumn = filterState.SortColumn;
                    _sortAscending = filterState.SortAscending;
                }
            }
        }
        catch (Exception ex)
        {
            // Ignore error or log it - filtering fails over to default
            await logger.LogError(ex, "Error Loading Filter State");
        }
    }

    private async Task CheckUserRoleAsync(string _role)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        IsDesignerRole = user.IsInRole(_role);

        if (IsDesignerRole && !user.IsInRole(SecurityAccessLevel.Admin.ToString()))
        {
            _designerUserId = PageState.User.UserId;
        }
    }

    private string GetUserName(int userId)
    {
        if (userId == 0)
        {
            return "Unassigned";
        }
        var user = _users?.FirstOrDefault(u => u.UserId == userId);

        return user?.DisplayName ?? $"Unknown User ({userId})";
    }

    private void Edit(int designRequestId)
    {
        NavigationManager.NavigateTo(NavigateUrl("edit", $"id={designRequestId}"));
    }

    private async Task Delete(int designRequestId)
    {
        try
        {
            await DesignRequestService.DeleteDesignRequestAsync(designRequestId, ModuleState.ModuleId);
            await logger.LogInformation("Design Request Deleted {DesignRequestId}", designRequestId);

            // Reload all data and re-apply filters
            _allDesignRequests = await DesignRequestService.GetDesignRequestsAsync(ModuleState.ModuleId);
            ApplyFilters();

            AddModuleMessage(Localizer["Design Request Deleted Successfully"], MessageType.Success);
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Deleting Design Request {Error}", ex.Message);
            AddModuleMessage(Localizer["Error Deleting Design Request"], MessageType.Error);
        }
    }
}