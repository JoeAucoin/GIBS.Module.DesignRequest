@using System.Net
@using Oqtane.Modules.Controls
@using GIBS.Module.DesignRequest.Services
@using GIBS.Module.DesignRequest.Models
@using Oqtane.Services
@using Oqtane.Models
@using System.Text
@using Microsoft.AspNetCore.Components.Authorization


@namespace GIBS.Module.DesignRequest
@inherits ModuleBase
@inject Services.IDesignRequestService DesignRequestService
@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<Index> Localizer


    <div class="text-end">
    <ActionLink Action="BackOffice" Security="SecurityAccessLevel.Edit" Style="margin-right:10px;" Class="btn btn-secondary mb-2" IconName="menu" Text="BackOffice" ResourceKey="BackOffice" />
    </div>


@if (!IsLoggedIn)
{
    <div class="alert alert-warning text-center">
        <h4>Please Login</h4>
        <p>You must be logged in to access your Design Dashboard and purchase credits.</p>
        <a href="@NavigateUrl("login")" class="btn btn-primary">Login Now</a>
    </div>
}
else
{
    <div class="container-fluid">
        <!-- HEADER: Balances and Actions -->
        <div class="row mb-4 align-items-center bg-light p-4 rounded shadow-sm">
            <div class="col-md-4">
                <h2 class="display-6">My Design Dashboard</h2>
                <p class="text-muted">Welcome back, @PageState.User.DisplayName</p>
            </div>
            <div class="col-md-4 text-center">
                <div class="d-inline-block bg-white p-3 rounded border text-center mx-2">
                    <span class="d-block text-uppercase small text-muted">Credit Balance</span>
                    <span class="h2 fw-bold @(_userCredits < 3 ? "text-danger" : "text-success")">@_userCredits</span>
                </div>
            </div>
            <div class="col-md-4 text-end">
               

                @if (_userCredits >= 3)
                {
                    @* Replaced ActionLink with standard anchor tag to support nested HTML (icon) *@
                    <a href="@NavigateUrl(ModuleState.ModuleId, "NewDesignRequest")" class="btn btn-lg btn-primary mx-2">
                        <span class="oi oi-plus"></span> New Design Request<br />(3 Credits)
                    </a>
                }
                else
                {
                    <button class="btn btn-lg btn-secondary mx-2" disabled>
                        Insufficient Credits
                    </button>
                }
            </div>
        </div>

        <!-- PURCHASE CREDITS SECTION -->
        <div class="row mb-5">
            <div class="col-12">
                <h4 class="mb-3">Purchase Credits</h4>
            </div>
            @foreach (var pkg in _packages)
            {
                <div class="col-md-4 mb-3">
                    <div class="card h-100 border-primary">
                        <div class="card-header text-center bg-primary text-white">
                            <h4 class="my-0 text-white">@pkg.Name</h4>
                        </div>
                        <div class="card-body text-center d-flex flex-column">
                            <h1 class="card-title pricing-card-title">$@pkg.Price.ToString("F0") <small class="text-muted">/ @pkg.Credits Credits</small></h1>
                            <ul class="list-unstyled mt-3 mb-4 flex-grow-1">
                                <li>@pkg.Description</li>
                                <li><strong>$@((pkg.Price / pkg.Credits).ToString("F2"))</strong> per credit</li>
                            </ul>
                            <button type="button" class="btn btn-lg btn-outline-primary" @onclick="() => InitiatePayPalPurchase(pkg)">Buy Now</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- ACTIVE JOBS -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Active Design Requests</h5>
                    </div>

                    <Pager Items="@_activeJobs" PageSize="5" Class="table table-striped table-hover align-middle mb-0">
                        <Header>
                        
                        <th class="fw-bold">@Localizer["ProjectName"]</th>
                        <th>@Localizer["Status"]</th>
                        <th>@Localizer["ProjectManager"]</th>
                        <th>@Localizer["CreatedOn"]</th>
                        <th>@Localizer["Revisions"]</th>
                        <th>@Localizer["Action"]</th>
                      
                        </Header>
                        <Row>
                            <td>@context.ProjectName</td>
                            <td><span class="badge bg-info text-dark">@context.ProjectStatus</span></td>
                           
                            <td>@GetUserName(context.ProjectManagerUserId ?? 0)</td>
                            <td>@context.CreatedOn.ToShortDateString()</td>
                            <td>
                                <span class="badge bg-secondary">@(context.RevisionsUsed ?? 0) / 2 Free</span>
                            </td>
                            <td>
                                <ActionLink Action="DesignRequestUpdate" Parameters="@($"id={context.DesignRequestId}")" Security="SecurityAccessLevel.View" Class="btn btn-sm btn-outline-dark" Text="View" />
                            </td>
                        </Row>
                    </Pager>
                </div>
            </div>
        </div>

        <!-- PAST HISTORY -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h5 class="mb-0 text-muted">Past History</h5>
                        <a href="@NavigateUrl(ModuleState.ModuleId, "ListJobs")" class="btn btn-sm btn-link">
                        View All Transaction History</a>
                    </div>
                    <Pager Items="@_historyJobs" PageSize="10" Class="table table-sm text-muted mb-0">
                        <Header>
                        <th>@Localizer["Date"]</th>
                        <th>@Localizer["Project"]</th>
                        <th>@Localizer["ProjectManager"]</th>
                        <th>@Localizer["Status"]</th>
                        <th class="text-center">@Localizer["Revisions"]</th>
                        <th class="text-center">@Localizer["Credits Used"]</th>
                        </Header>
                        <Row>
                            <td>@context.CreatedOn.ToShortDateString()</td>
                            <td>@context.ProjectName</td>
                            <td>@GetUserName(context.ProjectManagerUserId ?? 0)</td>
                            <td><span class="badge bg-success text-white">@context.ProjectStatus</span></td>
                            <td class="text-center">
                                <span class="badge bg-secondary">@(context.RevisionsUsed ?? 0)</span>
                            </td>
                            <td class="text-center">
                                <span class="badge @(context.CreditsSpent > 0 ? "bg-success" : "bg-secondary")">
                                    @(context.CreditsSpent ?? 3)
                                </span>
                            </td>
                        </Row>
                    </Pager>
                </div>
            </div>
        </div>

    </div>
}

@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.View;

    private bool IsLoggedIn = false;
    private int _userCredits = 0;
    private int _clientUserId = 0;

    private List<User> _users;
    // Additional properties mimicking the models for the wireframe
    private List<CreditPackage> _packages = new();
    private List<DesignRequest> _activeJobs = new();
    private List<DesignRequest> _historyJobs = new();

    protected override async Task OnInitializedAsync()
    {
        IsLoggedIn = PageState.User != null && PageState.User.IsAuthenticated;
        if (IsLoggedIn)
        {
            _clientUserId = this.PageState.User.UserId; // Get current user

        }

        _users = await DesignRequestService.GetUsersAsync();
        

        UserCredit userCredit = await DesignRequestService.GetUserCreditByUserAsync(ModuleState.ModuleId, _clientUserId);
        _userCredits = userCredit?.CreditBalance ?? 0;

        IEnumerable<CreditPackage> packages = await DesignRequestService.GetCreditPackagesAsync(ModuleState.ModuleId);
        _packages = packages.Where(x => x.IsActive).OrderBy(x => x.Price).ToList();


        // Fetch the complete list of requests for client-side pagination
        var requests = await DesignRequestService.GetDesignRequestsAsync(ModuleState.ModuleId);
        IEnumerable<Models.DesignRequest> query = requests;

        if (_clientUserId > 0)
        {
            query = query.Where(r => r.UserId == _clientUserId);
        }
        query = query.OrderByDescending(r => r.DesignRequestId).ToList();

        _activeJobs = query.Where(r => r.ProjectStatus == "Active").ToList();

        _historyJobs = query.Where(r => r.ProjectStatus != "Active").ToList();

    }

    private void InitiatePayPalPurchase(CreditPackage package)
    {
        // This is where we will trigger the PayPal integration
        // 1. Create a PaymentRecord with Pending status
        // 2. Redirect to PayPal Checkout
        Console.WriteLine($"Initiating purchase for {package.Name} at ${package.Price}");
        AddModuleMessage($"Simulating Gateway Redirect for {package.Name}...", MessageType.Info);
    }

    private string GetUserName(int userId)
    {
        if (userId == 0)
        {
            return "Unassigned";
        }
        var user = _users?.FirstOrDefault(u => u.UserId == userId);
        return user?.DisplayName ?? $"Unknown User ({userId})";
    }
}