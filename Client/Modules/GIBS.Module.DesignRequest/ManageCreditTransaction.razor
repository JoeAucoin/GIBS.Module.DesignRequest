@using System.Net
@using System.Linq
@using Oqtane.Modules.Controls
@using GIBS.Module.DesignRequest.Services
@using GIBS.Module.DesignRequest.Models
@using Oqtane.Services
@using Oqtane.Models
@using Microsoft.AspNetCore.Components.Forms

@namespace GIBS.Module.DesignRequest
@inherits ModuleBase
@inject IDesignRequestService DesignRequestService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<ManageCreditTransaction> Localizer
@inject IUserService UserService

<h3>Credit Transactions</h3>

@if (_isEditing)
{
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Edit Transaction #@_editingTx.TransactionId</h5>
            <small class="fs-4 text-muted">@_editingDisplayName</small>
        </div>
        <div class="card-body">
            <EditForm Model="@_editingTx" OnValidSubmit="@SaveAsync">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Credits (use negative for debits)</label>
                        <InputNumber class="form-control" @bind-Value="_editingTx.Credits" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Price</label>
                        <InputNumber class="form-control" @bind-Value="_editingTx.Price" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Type</label>
                        <InputText class="form-control" @bind-Value="_editingTx.TransactionType" />
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Design Request Id</label>
                        <InputNumber class="form-control" @bind-Value="_editingTx.DesignRequestId" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Notes</label>
                        <InputText class="form-control" @bind-Value="_editingTx.Notes" />
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
                <br />
                <AuditInfo CreatedBy="@_editingTx.CreatedBy" CreatedOn="@_editingTx.CreatedOn" ModifiedBy="@_editingTx.ModifiedBy" ModifiedOn="@_editingTx.ModifiedOn"></AuditInfo>
            </EditForm>
        </div>
    </div>
}
else
{
    @if (_txList == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="row mb-3">
            <div class="col-md-6 offset-md-6 text-end">
                <button class="btn btn-secondary btn-sm" @onclick="Refresh"><span class="oi oi-reload"></span> Refresh</button>
            </div>
        </div>

        <Pager Items="@_txList" SearchProperties="DesignRequestId,DisplayName,TransactionType" PageSize="10" Class="table table-striped table-hover align-middle mb-0">
            <Header>
            <th>@Localizer["TransactionId"]</th>
            <th>@Localizer["DesignRequestId"]</th>
            <th>@Localizer["User"]</th>
            <th class="text-center">@Localizer["Credits"]</th>
            <th class="text-end">@Localizer["Price"]</th>
            <th>@Localizer["Type"]</th>
            <th>@Localizer["Date"]</th>
            <th class="text-center">@Localizer["Action"]</th>
            </Header>
            <Row>
                <td>@context.TransactionId</td>
                <td>@(context.DesignRequestId.HasValue? context.DesignRequestId.ToString() : "-")</td>
                <td>@context.DisplayName</td>
                <td class="text-center">
                    <span class="badge @(context.Credits >= 0 ? "bg-success" : "bg-danger")">@context.Credits</span>
                </td>
                <td class="text-end">$@context.Price.ToString("F2")</td>
                <td>@context.TransactionType</td>
                <td>@context.TransactionDate.ToShortDateString()</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-dark" @onclick="@(() => Edit(context.TransactionId))">View / Edit</button>
                </td>
            </Row>
        </Pager>
    }
}

<div class="text-center mt-3 mb-3">
    <ActionLink Action="BackOffice" Security="SecurityAccessLevel.Edit" Style="margin-right:10px;" Class="btn btn-secondary" IconName="menu" Text="Return to BackOffice" ResourceKey="BackOffice" />
</div>

@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;
    //interactive
    public override string RenderMode => RenderModes.Interactive;
    public override bool UseAdminContainer => false;

    private List<CreditTransaction> _txList;
    private List<User> _users;
    private bool _isEditing = false;
    private CreditTransaction _editingTx = new();
    private string _editingDisplayName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _users = await DesignRequestService.GetUsersAsync();
        var txs = await DesignRequestService.GetCreditTransactionsAsync(ModuleState.ModuleId);

        foreach (var t in txs)
        {
            t.DisplayName = _users.FirstOrDefault(u => u.UserId == t.UserId)?.DisplayName ?? $"User {t.UserId}";
        }

        _txList = txs.OrderByDescending(t => t.TransactionDate).ToList();
        StateHasChanged();
    }

    private async Task Refresh() => await LoadData();

    private async Task Edit(int transactionId)
    {
        _editingTx = await DesignRequestService.GetCreditTransactionAsync(transactionId, ModuleState.ModuleId);
        _editingDisplayName = _users.FirstOrDefault(u => u.UserId == _editingTx.UserId)?.DisplayName ?? $"User {_editingTx.UserId}";
        _isEditing = true;
    }

    private async Task SaveAsync()
    {
        await DesignRequestService.UpdateCreditTransactionAsync(_editingTx, ModuleState.ModuleId);
        AddModuleMessage("Transaction saved", MessageType.Success);
        _isEditing = false;
        await LoadData();
    }

    private void Cancel() => _isEditing = false;
}